<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hotel Rosenhaus - Buchungskalender</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script type="application/ld+json">
    {
      "@context": "https://hotel-rosenhaus.de/",
      "@type": "Hotel",
      "name": "Hotel Rosenhaus",
      "description": "Exklusives Hotel mit Bestpreis-Garantie. Sparen Sie 15% bei Langzeitaufenthalten ab 60 Nächten.",
      "priceRange": "90€ - 250€",
      "offers": {
        "@type": "Offer",
        "description": "Langzeitrabatt",
        "discount": "15%",
        "eligibleDuration": {
          "@type": "QuantitativeValue",
          "minValue": 60,
          "unitCode": "DAY"
        }
      }
    }
    </script>
    
    <style>
        /* --- MODERN CSS DESIGN --- */
        :root {
            --brand-primary: #8a1c33; 
            --brand-primary-hover: #6d1628;
            --brand-secondary: #c5a065; 
            --brand-bg: #fdfbf7; 
            --text-main: #2c2c2c;
            --text-light: #666666;
            --border-color: #e8e3db;
            --blocked-color: #f8f8f8;
            --blocked-text: #d0d0d0;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 30px 15px;
            line-height: 1.6;
        }

        #price-calendar-widget {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px;
            border-radius: 20px;
            background: linear-gradient(to bottom, #ffffff 0%, #fefefe 100%);
            color: var(--text-main);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.8);
            position: relative;
            overflow: hidden;
        }

        /* Decorative element */
        #price-calendar-widget::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--brand-primary) 0%, var(--brand-secondary) 100%);
        }

        #price-calendar-widget h2 {
            margin: 0 0 35px;
            font-size: 32px;
            color: var(--brand-primary);
            font-family: 'Playfair Display', serif;
            text-align: center;
            font-weight: 700;
            letter-spacing: 0.5px;
            position: relative;
            padding-bottom: 20px;
        }

        #price-calendar-widget h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--brand-secondary), transparent);
            border-radius: 2px;
        }

        /* Controls Section */
        .pcw-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 35px;
            padding: 25px;
            background: linear-gradient(135deg, #fdfbf7 0%, #f9f6f0 100%);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .pcw-control {
            display: flex;
            flex-direction: column;
        }

        .pcw-control label:not(.pcw-breakfast-control) {
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            color: var(--text-light);
            letter-spacing: 0.8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pcw-control label i {
            color: var(--brand-secondary);
            font-size: 14px;
        }

        .pcw-control select,
        .pcw-control input[type="number"] {
            padding: 14px 16px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            font-size: 15px;
            background-color: white;
            transition: all 0.3s ease;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
        }

        .pcw-control select:focus,
        .pcw-control input[type="number"]:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(138, 28, 51, 0.1);
            transform: translateY(-1px);
        }

        .pcw-control select:hover,
        .pcw-control input[type="number"]:hover {
            border-color: var(--brand-secondary);
        }

        /* Breakfast Toggle - Same size as inputs */
        #pcw-breakfast {
            display: none;
        }

        .pcw-breakfast-control {
            display: flex;
            background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 14px 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            user-select: none;
            box-shadow: var(--shadow-sm);
            min-width: 180px;
            height: 51px;
            align-items: center;
        }

        .pcw-breakfast-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 10px;
        }

        .pcw-breakfast-control:hover:not(:has(input:checked)) {
            border-color: var(--brand-secondary);
            background: linear-gradient(135deg, #fffef8 0%, #fdfbf7 100%);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .pcw-breakfast-control:has(input:checked) {
            background: linear-gradient(135deg, var(--brand-primary) 0%, #6d1628 100%);
            border-color: var(--brand-primary);
            box-shadow: 0 4px 14px rgba(138, 28, 51, 0.25);
            transform: translateY(-1px);
        }

        .pcw-breakfast-text {
            display: flex;
            flex-direction: column;
            gap: 1px;
            flex: 1;
            text-align: left;
        }

        .pcw-breakfast-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 5px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            transition: color 0.3s;
            line-height: 1.2;
        }

        .pcw-breakfast-subtitle {
            font-size: 10px;
            color: var(--text-light);
            transition: color 0.3s;
            font-weight: 500;
            line-height: 1.2;
        }

        .pcw-breakfast-control:has(input:checked) .pcw-breakfast-title,
        .pcw-breakfast-control:has(input:checked) .pcw-breakfast-subtitle {
            color: #ffffff;
        }

        .pcw-toggle-track {
            width: 40px;
            height: 22px;
            background-color: #e0e0e0;
            border-radius: 11px;
            position: relative;
            transition: background-color 0.3s;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .pcw-toggle-handle {
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 3px;
            left: 3px;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        }

        #pcw-breakfast:checked + .pcw-breakfast-content .pcw-toggle-track {
            background-color: rgba(255, 255, 255, 0.35);
        }

        #pcw-breakfast:checked + .pcw-breakfast-content .pcw-toggle-handle {
            transform: translateX(18px);
        }

        #pcw-breakfast:checked + .pcw-breakfast-content .pcw-toggle-handle {
            transform: translateX(22px);
        }

        /* Legend */
        .pcw-legend {
            font-size: 12px;
            color: var(--text-light);
            margin-bottom: 25px;
            text-align: center;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .pcw-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .pcw-legend-box {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        /* Calendar Header */
        .pcw-calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .pcw-calendar-header-title {
            font-weight: 700;
            font-size: 24px;
            font-family: 'Playfair Display', serif;
            color: var(--brand-primary);
            letter-spacing: 0.5px;
        }

        .pcw-month-nav {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background: white;
            color: var(--text-main);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 16px;
            box-shadow: var(--shadow-sm);
        }

        .pcw-month-nav:hover {
            background: linear-gradient(135deg, var(--brand-primary) 0%, #6d1628 100%);
            color: #fff;
            border-color: var(--brand-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .pcw-month-nav:active {
            transform: translateY(0);
        }

        /* Calendar Table */
        .pcw-calendar-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 8px;
            table-layout: fixed;
        }

        .pcw-calendar-table th {
            padding: 12px 0;
            text-align: center;
            font-weight: 700;
            font-size: 13px;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--border-color);
        }

        .pcw-calendar-table td {
            padding: 0;
            height: 100px;
            vertical-align: top;
        }

        .pcw-day-cell {
            width: 100%;
            height: 100%;
            cursor: pointer;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            background: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .pcw-day-cell:hover:not(.pcw-day--disabled):not(.pcw-day--blocked) {
            border-color: var(--brand-primary);
            transform: translateY(-3px) scale(1.02);
            z-index: 10;
            box-shadow: 0 8px 20px rgba(138, 28, 51, 0.15);
        }

        .pcw-day-number {
            font-weight: 700;
            font-size: 16px;
            color: var(--text-main);
        }

        .pcw-price-container {
            text-align: right;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .pcw-old-price {
            font-size: 11px;
            color: #aaa;
            text-decoration: line-through;
            font-weight: 400;
        }

        .pcw-day-price {
            font-size: 16px;
            font-weight: 800;
            color: var(--brand-primary);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .pcw-day-price::before {
            content: '€';
            font-size: 11px;
            font-weight: 600;
        }

        /* Day States */
        .pcw-day-cell-empty {
            cursor: default;
            background: transparent;
            border: none;
            box-shadow: none;
        }

        .pcw-day--today {
            background: linear-gradient(135deg, #fffef8 0%, #fffbf0 100%);
            border-color: var(--brand-secondary);
            box-shadow: 0 0 0 2px rgba(197, 160, 101, 0.2);
        }
        
        .pcw-day--selected-start {
            background: linear-gradient(135deg, var(--brand-primary) 0%, #6d1628 100%) !important;
            border-color: var(--brand-primary) !important;
            color: #fff !important;
            box-shadow: 0 6px 20px rgba(138, 28, 51, 0.3) !important;
        }
        
        .pcw-day--selected-start .pcw-day-price,
        .pcw-day--selected-start .pcw-day-number,
        .pcw-day--selected-start .pcw-old-price {
            color: #fff !important;
        }
        
        .pcw-day--in-range {
            background: linear-gradient(135deg, rgba(138, 28, 51, 0.08) 0%, rgba(138, 28, 51, 0.12) 100%);
            border-color: rgba(138, 28, 51, 0.3);
        }

        .pcw-day--hover-range {
            background: linear-gradient(135deg, rgba(197, 160, 101, 0.25) 0%, rgba(197, 160, 101, 0.35) 100%) !important;
            border-color: var(--brand-secondary) !important;
        }

        .pcw-day--blocked {
            background: linear-gradient(135deg, var(--blocked-color) 0%, #f5f5f5 100%);
            color: var(--blocked-text);
            cursor: not-allowed;
            border-color: #eee;
            opacity: 0.6;
        }
        
        .pcw-day--blocked .pcw-price-container { 
            display: none; 
        }

        .pcw-day--blocked::after {
            content: '✕';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            color: #ddd;
        }

        /* Summary Section */
        .pcw-summary {
            margin-top: 35px;
            padding: 30px;
            background: linear-gradient(135deg, #fdfbf7 0%, #f9f6f0 100%);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }

        .pcw-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 15px;
            border-bottom: 1px dashed rgba(0,0,0,0.1);
            padding-bottom: 8px;
            font-weight: 500;
        }

        .pcw-summary-row:last-of-type {
            border-bottom: none;
        }

        .pcw-summary-row i {
            margin-right: 8px;
            color: var(--brand-secondary);
            font-size: 14px;
        }

        .pcw-summary-total {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 3px solid var(--brand-primary);
            font-weight: 700;
            font-size: 22px;
            color: var(--brand-primary);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .pcw-summary-total i {
            margin-right: 10px;
            font-size: 20px;
        }

        /* Actions */
        .pcw-actions {
            margin-top: 30px;
            text-align: center;
        }

        .pcw-booking-btn {
            padding: 18px 50px;
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            background: linear-gradient(135deg, var(--brand-primary) 0%, #6d1628 100%);
            color: #ffffff;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(138, 28, 51, 0.3);
            position: relative;
            overflow: hidden;
        }

        .pcw-booking-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .pcw-booking-btn:hover::before {
            left: 100%;
        }

        .pcw-booking-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(138, 28, 51, 0.4);
        }

        .pcw-booking-btn:active {
            transform: translateY(-1px);
        }

        .pcw-booking-btn i {
            margin-left: 10px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #price-calendar-widget { 
                padding: 25px 20px; 
            }
            
            #price-calendar-widget h2 {
                font-size: 26px;
            }
            
            .pcw-controls {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px;
            }
            
            .pcw-calendar-table td { 
                height: 85px; 
            }
            
            .pcw-day-cell {
                padding: 8px;
            }
            
            .pcw-day-number {
                font-size: 14px;
            }
            
            .pcw-day-price {
                font-size: 14px;
            }
            
            .pcw-booking-btn { 
                width: 100%; 
                padding: 16px 30px;
            }
            
            .pcw-legend {
                font-size: 11px;
                gap: 12px;
            }
            
            .pcw-calendar-header-title {
                font-size: 20px;
            }
        }

        @media (max-width: 500px) {
            body {
                padding: 15px 10px;
            }
            
            .pcw-calendar-table {
                border-spacing: 4px;
            }
            
            .pcw-calendar-table td {
                height: 75px;
            }
            
            .pcw-day-cell {
                padding: 6px;
                border-radius: 6px;
            }
            
            .pcw-old-price {
                font-size: 10px;
            }
        }

        /* Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pcw-calendar-table tbody tr {
            animation: fadeIn 0.4s ease-out;
        }
    </style>
</head>
<body>

<div id="price-calendar-widget">
    <h2>Verfügbarkeit & Preise</h2>

    <div class="pcw-controls">
        <div class="pcw-control">
            <label for="pcw-room-type">
                <i class="fas fa-bed"></i>
                Zimmerkategorie
            </label>
            <select id="pcw-room-type">
                <option value="EZ">Einzelzimmer (EZ)</option>
                <option value="DZ">Doppelzimmer (DZ)</option>
                <option value="SUITE">Suite</option>
            </select>
        </div>

        <div class="pcw-control">
            <label for="pcw-guests">
                <i class="fas fa-users"></i>
                Personen
            </label>
            <input id="pcw-guests" type="number" min="1" max="6" value="2">
        </div>

        <div class="pcw-control">
            <label for="pcw-nights">
                <i class="fas fa-moon"></i>
                Nächte
            </label>
            <input id="pcw-nights" type="number" min="1" max="90" value="1">
        </div>
        
        <label class="pcw-control pcw-breakfast-control" for="pcw-breakfast">
            <input type="checkbox" id="pcw-breakfast">
            <div class="pcw-breakfast-content">
                <div class="pcw-breakfast-text">
                    <span class="pcw-breakfast-title">
                        <i class="fas fa-coffee"></i>
                        Frühstück
                    </span>
                    <span class="pcw-breakfast-subtitle">+15€ / Person</span>
                </div>
                
                <div class="pcw-toggle-track">
                    <div class="pcw-toggle-handle"></div>
                </div>
            </div>
        </label>
    </div>
    
    <div class="pcw-legend">
        <div class="pcw-legend-item">
            <div class="pcw-legend-box" style="background: linear-gradient(135deg, var(--brand-primary) 0%, #6d1628 100%);"></div>
            <span>Anreise/Abreise</span>
        </div>
        <div class="pcw-legend-item">
            <div class="pcw-legend-box" style="background: rgba(138, 28, 51, 0.1); border: 2px solid var(--brand-primary);"></div>
            <span>Ausgewählter Zeitraum</span>
        </div>
        <div class="pcw-legend-item">
            <div class="pcw-legend-box" style="background: var(--blocked-color);"></div>
            <span>Nicht verfügbar</span>
        </div>
    </div>

    <div class="pcw-calendar">
        <div class="pcw-calendar-header">
            <button type="button" class="pcw-month-nav" id="pcw-prev-month">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="pcw-calendar-header-title" id="pcw-month-label"></div>
            <button type="button" class="pcw-month-nav" id="pcw-next-month">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>

        <table class="pcw-calendar-table" id="pcw-calendar-table">
            <thead>
            <tr>
                <th>Mo</th><th>Di</th><th>Mi</th><th>Do</th><th>Fr</th><th>Sa</th><th>So</th>
            </tr>
            </thead>
            <tbody id="pcw-calendar-body"></tbody>
        </table>
    </div>

    <div class="pcw-summary" id="pcw-summary"></div>

    <div class="pcw-actions">
        <button type="button" class="pcw-booking-btn" id="pcw-booking-btn">
            Buchungsanfrage
            <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

<script>
(function(){
  // Инициализация переменных
  let roomTypes = {};
  let specialPriceRules = [];
  let blockedDates = [];
  let longStayNights = 60;
  let longStayDiscount = 0.15;

  // Элементы DOM
  const roomSelect = document.getElementById('pcw-room-type');
  const guestsInput = document.getElementById('pcw-guests');
  const nightsInput = document.getElementById('pcw-nights');
  const breakfastCheck = document.getElementById('pcw-breakfast');
  const monthLabel = document.getElementById('pcw-month-label');
  const prevMonthBtn = document.getElementById('pcw-prev-month');
  const nextMonthBtn = document.getElementById('pcw-next-month');
  const calendarBody = document.getElementById('pcw-calendar-body');
  const summaryEl = document.getElementById('pcw-summary');
  const bookingBtn = document.getElementById('pcw-booking-btn');

  const today = new Date(); today.setHours(0,0,0,0);
  let currentYear = today.getFullYear(), currentMonth = today.getMonth();
  let startDate = null, endDate = null;

  // Вспомогательные функции
  function pad(n){ return n<10?'0'+n:n; }
  function formatDate(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
  function formatDateDisplay(d){ return pad(d.getDate())+'.'+pad(d.getMonth()+1)+'.'+d.getFullYear(); }
  function cloneDate(d){ return new Date(d.getTime()); }

  function isDateBlocked(d){ return blockedDates.includes(formatDate(d)) || d<today; }
  
  function isRangeAvailable(s,e){ 
    let temp=cloneDate(s); 
    while(temp<e){ 
      if(isDateBlocked(temp)) return false; 
      temp.setDate(temp.getDate()+1); 
    } 
    return true; 
  }
  
  function diffDays(d1,d2){ return Math.ceil((d2.getTime()-d1.getTime())/(1000*3600*24)); }

  // Расчет цены для одной даты
  function getPriceForDate(roomKey, date, guests){
    const room = roomTypes[roomKey]; 
    if(!room) return {final:0, fake:0};
    
    let price = room.basePrice;
    
    // Для DZ: если 1 гость - используем специальную цену для одного
    if(roomKey === 'DZ' && guests === 1 && room.basePriceSingle) {
      price = room.basePriceSingle;
    }
    
    const dateStr = formatDate(date);

    // Проверка спецпредложений и сезонных цен
    const rule = specialPriceRules.find(r => { 
      const matchDate = (dateStr >= r.start && dateStr <= r.end); 
      const matchRoom = !r.roomType || r.roomType === roomKey; 
      return matchDate && matchRoom; 
    });

    if(rule){ 
      // Для DZ с 1 гостем проверяем fixedPriceSingle
      if(roomKey === 'DZ' && guests === 1 && rule.fixedPriceSingle) {
        price = rule.fixedPriceSingle;
      } else if(rule.fixedPrice) {
        price = rule.fixedPrice;
      } else if(rule.multiplier) {
        price *= rule.multiplier;
      }
    }

    // ЗАКОММЕНТИРОВАНО: Доплата за дополнительных гостей
    // if (guests > room.maxGuests) {
    //     price += (guests - room.maxGuests) * 20;
    // }

    // ЗАКОММЕНТИРОВАНО: Выходные +10%
    // if(date.getDay()===5 || date.getDay()===6) price *= 1.1;

    return {final:Math.round(price*10)/10, fake:Math.round(price*1.2*10)/10};
  }

  // Расчет итоговой суммы
  function calculateTotal(){
    if(!startDate || !endDate) return null;
    const nights = diffDays(startDate, endDate); 
    if(nights <= 0) return null;
    
    const roomKey = roomSelect.value; 
    const guests = parseInt(guestsInput.value)||1;
    const room = roomTypes[roomKey];
    
    let total = 0, fakeTotal = 0; 
    let cursor = cloneDate(startDate);
    
    // Сумма за проживание
    for(let i=0; i<nights; i++){ 
      const p = getPriceForDate(roomKey, cursor, guests); 
      total += p.final; 
      fakeTotal += p.fake; 
      cursor.setDate(cursor.getDate()+1); 
    }
    
    // Сумма за завтрак (для DZ с 1 гостем используем цену для одного)
    let breakfastCostPerNight = 0;
    if(room) {
      if(roomKey === 'DZ' && guests === 1 && room.breakfastPriceSingle) {
        breakfastCostPerNight = room.breakfastPriceSingle;
      } else {
        breakfastCostPerNight = room.breakfastPrice || 0;
      }
    }
    
    const breakfastTotal = breakfastCheck.checked ? (breakfastCostPerNight * nights) : 0;
    
    let finalSum = total + breakfastTotal; 
    let isLong = false;
    
    if(nights >= longStayNights){ 
      finalSum *= (1 - longStayDiscount); 
      isLong = true; 
    }
    
    return {
      total: Math.round(finalSum*10)/10, 
      fakeTotal: Math.round((fakeTotal + breakfastTotal)*10)/10, 
      nights, 
      breakfast: Math.round(breakfastTotal*10)/10, 
      breakfastPerNight: Math.round(breakfastCostPerNight*10)/10,
      isLong
    };
  }

  // Отрисовка календаря
  function renderCalendar(){
    const roomKey = roomSelect.value;
    const guests = parseInt(guestsInput.value)||1;
    
    const monthNames=['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
    monthLabel.textContent = monthNames[currentMonth] + ' ' + currentYear;
    
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth+1, 0);
    let startWeekday = firstDay.getDay() - 1; 
    if(startWeekday < 0) startWeekday = 6;
    
    calendarBody.innerHTML = ''; 
    let day = 1;
    
    for(let row=0; row<6; row++){
      const tr = document.createElement('tr');
      for(let col=0; col<7; col++){
        const td = document.createElement('td');
        if((row===0 && col<startWeekday) || day > lastDay.getDate()){ 
          td.innerHTML='<div class="pcw-day-cell pcw-day-cell-empty"></div>'; 
        } else {
          const d = new Date(currentYear, currentMonth, day);
          const blocked = isDateBlocked(d);
          const cell = document.createElement('div');
          cell.className = 'pcw-day-cell' + (blocked ? ' pcw-day--blocked' : '');
          
          if(!blocked){
            if(startDate && d.getTime()===startDate.getTime()) cell.classList.add('pcw-day--selected-start');
            if(startDate && endDate){ 
              if(d > startDate && d < endDate) cell.classList.add('pcw-day--in-range'); 
              if(d.getTime() === endDate.getTime()) cell.classList.add('pcw-day--selected-start'); 
            }
            
            const p = getPriceForDate(roomKey, d, guests);
            cell.innerHTML=`<div class="pcw-day-number">${day}</div><div class="pcw-price-container"><span class="pcw-old-price">${p.fake}€</span><span class="pcw-day-price">${p.final}</span></div>`;
            
            cell.onclick = () => { 
              if(!startDate || endDate){ startDate=d; endDate=null; } 
              else if(d > startDate){ 
                if(isRangeAvailable(startDate, d)) endDate=d; 
                else alert('Im ausgewählten Zeitraum gibt es nicht verfügbare Daten!'); 
              } else startDate=d; 
              
              renderCalendar(); 
              renderSummary(); 
            };
          } else { 
            cell.innerHTML=`<div class="pcw-day-number">${day}</div>`; 
          }
          td.appendChild(cell); 
          day++;
        }
        tr.appendChild(td);
      }
      calendarBody.appendChild(tr);
      if (day > lastDay.getDate()) break;
    }
  }

  // Обновление сводки
  function renderSummary() {
    summaryEl.innerHTML = '';
    const room = roomTypes[roomSelect.value];

    if (!startDate) { 
        summaryEl.innerHTML = '<div style="text-align:center; color:#888; font-size:15px;"><i class="fas fa-info-circle" style="margin-right:8px; color:var(--brand-secondary);"></i>Bitte wählen Sie ein <b>Anreisedatum</b> im Kalender.</div>'; 
        return; 
    }
    if (!endDate) { 
        summaryEl.innerHTML = `<div style="text-align:center; color:#888; font-size:15px;"><i class="fas fa-calendar-check" style="margin-right:8px; color:var(--brand-secondary);"></i>Anreise: <b>${formatDateDisplay(startDate)}</b><br><br>Bitte wählen Sie ein <b>Abreisedatum</b>.</div>`; 
        return; 
    }

    const data = calculateTotal();
    
    summaryEl.innerHTML = `
      <div class="pcw-summary-row">
        <span><i class="fas fa-bed"></i>Zimmer:</span> 
        <strong>${room ? room.name : ''}</strong>
      </div>
      <div class="pcw-summary-row">
        <span><i class="fas fa-calendar-alt"></i>Zeitraum:</span> 
        <strong>${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}</strong>
      </div>
      <div class="pcw-summary-row">
        <span><i class="fas fa-moon"></i>Dauer:</span> 
        <strong>${data.nights} ${data.nights === 1 ? 'Nacht' : 'Nächte'}</strong>
      </div>
      ${data.breakfast > 0 ? `<div class="pcw-summary-row">
        <span><i class="fas fa-coffee"></i>Frühstück (${data.breakfastPerNight}€ × ${data.nights}):</span> 
        <strong>+${data.breakfast}€</strong>
      </div>` : ''}
      ${data.isLong ? `<div class="pcw-summary-row" style="color:var(--brand-secondary);">
        <span><i class="fas fa-percentage"></i>Langzeitrabatt (${data.nights}+ Nächte):</span> 
        <strong>-15%</strong>
      </div>` : ''}
      <div class="pcw-summary-total">
        <span><i class="fas fa-euro-sign"></i>Gesamtpreis:</span>
        <div style="text-align:right">
          <div class="pcw-old-price" style="font-size:16px">${data.fakeTotal}€</div>
          <div style="font-size:28px;">${data.total}€</div>
        </div>
      </div>
    `;
    nightsInput.value = data.nights;
  }

  // Обработчики событий
  prevMonthBtn.onclick = () => { 
    currentMonth--; 
    if (currentMonth < 0) { currentMonth = 11; currentYear--; } 
    renderCalendar(); 
  };
  
  nextMonthBtn.onclick = () => { 
    currentMonth++; 
    if (currentMonth > 11) { currentMonth = 0; currentYear++; } 
    renderCalendar(); 
  };
  
  roomSelect.onchange = () => { renderCalendar(); renderSummary(); };
  guestsInput.onchange = breakfastCheck.onchange = () => { renderCalendar(); renderSummary(); };
  
  nightsInput.onchange = () => {
      if(startDate && !endDate) {
          const days = parseInt(nightsInput.value);
          if(days > 0) {
              const newEnd = cloneDate(startDate);
              newEnd.setDate(newEnd.getDate() + days);
              if(isRangeAvailable(startDate, newEnd)) {
                  endDate = newEnd;
                  renderCalendar();
                  renderSummary();
              }
          }
      }
  };

  bookingBtn.onclick = () => {
    if (!startDate || !endDate) {
        alert('⚠️ Bitte wählen Sie Anreise- und Abreisedatum!');
        return;
    }
    
    // ПЕРЕНАПРАВЛЕНИЕ НА СТРАНИЦУ BUCHUNGSANFRAGE
    // TODO: Заменить URL на ваш Redaxo URL
    // window.location.href = '/buchungsanfrage'; 
    
    // Временное сообщение (удалите после добавления URL):
    const d = calculateTotal();
    alert(`✅ Ihre Buchungsanfrage wird verarbeitet!\n\nGesamtpreis: ${d.total}€\nZeitraum: ${formatDateDisplay(startDate)} - ${formatDateDisplay(endDate)}\n\nVielen Dank!`);
  };

  // --- ВСТРОЕННЫЕ ДАННЫЕ ---
  const calendarData = {
    "roomTypes": {
      "EZ": {
        "name": "Einzelzimmer (EZ)",
        "basePrice": 98,
        "maxGuests": 1,
        "breakfastPrice": 6.50
      },
      "DZ": {
        "name": "Doppelzimmer (DZ)",
        "basePrice": 131,
        "basePriceSingle": 112,
        "maxGuests": 2,
        "breakfastPrice": 13.00,
        "breakfastPriceSingle": 6.50
      },
      "SUITE": {
        "name": "Suite",
        "basePrice": 168,
        "maxGuests": 4,
        "breakfastPrice": 13.00
      }
    },
    "specialPriceRules": [
      {
        "comment": "Повышение цен с 1 марта 2026 - Einzelzimmer",
        "start": "2026-03-01",
        "end": "2027-02-28",
        "roomType": "EZ",
        "fixedPrice": 102
      },
      {
        "comment": "Повышение цен с 1 марта 2026 - Doppelzimmer (2 гостя)",
        "start": "2026-03-01",
        "end": "2027-02-28",
        "roomType": "DZ",
        "fixedPrice": 137
      },
      {
        "comment": "Повышение цен с 1 марта 2026 - Doppelzimmer (1 гость)",
        "start": "2026-03-01",
        "end": "2027-02-28",
        "roomType": "DZ",
        "fixedPriceSingle": 116.5
      },
      {
        "comment": "Повышение цен с 1 марта 2026 - Suite",
        "start": "2026-03-01",
        "end": "2027-02-28",
        "roomType": "SUITE",
        "fixedPrice": 175
      }
    ],
    "blockedDates": [
      "2026-12-24",
      "2026-12-25",
      "2027-01-01"
    ],
    "longStayNights": 60,
    "longStayDiscount": 0.15
  };

  // Инициализация с встроенными данными
  roomTypes = calendarData.roomTypes;
  specialPriceRules = calendarData.specialPriceRules;
  blockedDates = calendarData.blockedDates;
  if(calendarData.longStayNights) longStayNights = calendarData.longStayNights;
  if(calendarData.longStayDiscount) longStayDiscount = calendarData.longStayDiscount;

  roomSelect.innerHTML = '';
  for (const key in roomTypes) {
    const option = document.createElement('option');
    option.value = key;
    option.textContent = roomTypes[key].name;
    roomSelect.appendChild(option);
  }

  renderCalendar();
  renderSummary();

})();
</script>
</body>
</html>
